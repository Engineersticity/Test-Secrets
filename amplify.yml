# version: 1
# env:
#   variables:
#     TEST_API_KEY: $(aws ssm get-parameters --names /amplify/shared/d2akegycjuaux7/TEST_API_KEY --with-decryption --output text | awk '{print $7}')
# backend:
#   phases:
#     build:
#       commands:
#         - npm ci --cache .npm --prefer-offline
#         - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
# frontend:
#   phases:
#     build:
#       commands:
#         - echo "VITE_TEST_API_KEY=$TEST_API_KEY" >> .env
#         - cat .env
#         - npm run build
#   artifacts:
#     baseDirectory: dist
#     files:
#       - '**/*'
#   cache:
#     paths:
#       - .npm/**/*
#       - node_modules/**/*


version: 1
frontend:
  phases:
    preBuild:
      commands:
        - sudo dnf install -y jq
        # Move the secrets fetching here after jq is installed
        - aws ssm get-parameters-by-path --path /amplify/shared/d2akegycjuaux7 --recursive --with-decryption --output json | jq -r '.Parameters[] | "VITE_" + (split("/")[-1]) + "=\"" + .Value + "\""' > .env
        - cat .env
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*